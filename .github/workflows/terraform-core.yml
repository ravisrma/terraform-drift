name: Terraform Core

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      region:
        required: true
        type: string
    secrets:
      AWS_ROLE:
        required: true
      SLACK_WEBHOOK:
        required: true
      MY_GITHUB_TOKEN:
        required: true

jobs:
  terraform:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: write
      issues: write
    defaults:
      run:
        working-directory: terraform
    env:
      TF_BUCKET: terraform-drift-005

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          aws-region: ${{ inputs.region }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.10.3
          terraform_wrapper: false          

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${TF_BUCKET}" \
            -backend-config="key=${{ inputs.environment }}/${{ inputs.region }}/terraform.tfstate" \
            -backend-config="region=${{ inputs.region }}" \
            -backend-config="encrypt=true"

      - name: Terraform Plan (Drift Detection)
        id: plan
        run: |
          set +e  # Don't exit on error
          terraform plan \
            -var-file=./stage_variables/${{ inputs.environment }}/${{ inputs.region }}.tfvars \
            -var="aws_region=${{ inputs.region }}" \
            -var="environment=${{ inputs.environment }}" \
            -detailed-exitcode -no-color > plan_output.txt 2>&1
          EXIT_CODE=$?
          echo "exitcode=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Extract resource change counts from plan output
          ADD_COUNT=$(grep -oP '\d+(?= to add)' plan_output.txt || echo "0")
          CHANGE_COUNT=$(grep -oP '\d+(?= to change)' plan_output.txt || echo "0")
          DESTROY_COUNT=$(grep -oP '\d+(?= to destroy)' plan_output.txt || echo "0")
          TOTAL_DRIFT=$((${ADD_COUNT:-0} + ${CHANGE_COUNT:-0} + ${DESTROY_COUNT:-0}))
          
          echo "add_count=${ADD_COUNT:-0}" >> $GITHUB_OUTPUT
          echo "change_count=${CHANGE_COUNT:-0}" >> $GITHUB_OUTPUT
          echo "destroy_count=${DESTROY_COUNT:-0}" >> $GITHUB_OUTPUT
          echo "total_drift=${TOTAL_DRIFT}" >> $GITHUB_OUTPUT
          
          cat plan_output.txt
          exit 0  # Always succeed so workflow continues

      - name: Analyze Drift
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/github-script@v6
        env:
          PLAN_OUTPUT: plan_output.txt
        with:
          github-token: ${{ secrets.MY_GITHUB_TOKEN }}
          script: |
            process.chdir('terraform');
            const fs = require('fs');
            const planOutput = fs.readFileSync(process.env.PLAN_OUTPUT, 'utf8');
            const body = `### Drift Detected & Auto-Remediation Started

            Terraform has detected changes in the infrastructure that are not in the state file.
            Auto-fix will be applied automatically.

            <details>
            <summary>Show Plan</summary>

            \`\`\`terraform
            ${planOutput.slice(0, 65000)}
            \`\`\`

            </details>

            Action: Auto-applying changes...`;

            // Check for existing drift issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              creator: 'github-actions[bot]',
              labels: 'drift-detection'
            });

            const env = '${{ inputs.environment }}';
            const existingIssue = issues.data.find(issue => 
              issue.title.includes(`Terraform Drift Detected [${env}]`)
            );

            if (existingIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## New Drift Detected\n\n${body}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üö® Terraform Drift Detected [${env}]`,
                body: body,
                labels: ['drift-detection', 'auto-fix', env]
              });
            } 
              
      - name: Auto-Fix Drift
        if: steps.plan.outputs.exitcode == '2'
        id: apply
        run: |
          echo "Applying Terraform changes to fix drift..."
          terraform apply \
            -var-file=./stage_variables/${{ inputs.environment }}/${{ inputs.region }}.tfvars \
            -var="aws_region=${{ inputs.region }}" \
            -var="environment=${{ inputs.environment }}" \
            -auto-approve -no-color > apply_output.txt 2>&1
        continue-on-error: true 

      - name: Show Apply Output on Failure
        if: steps.plan.outputs.exitcode == '2' && steps.apply.outcome == 'failure'
        run: cat apply_output.txt        
      - name: Notify Slack - Drift Detected & Fixed
        if: steps.plan.outputs.exitcode == '2' && steps.apply.outcome == 'success'
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "‚úÖ Terraform Drift Auto-Fixed",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "‚úÖ Drift Detected & Automatically Fixed"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Workflow:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "Terraform has automatically applied changes to remediate infrastructure drift."
                }
              }
            ]
          }'

      - name: Notify Slack - Auto-Fix Failed
        if: steps.plan.outputs.exitcode == '2' && steps.apply.outcome == 'failure'
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "‚ùå Terraform Drift Auto-Fix Failed",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "‚ùå Drift Detected but Auto-Fix Failed"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Workflow:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>\n\n‚ö†Ô∏è *Manual intervention required!*"
                }
              }
            ]
          }'

      - name: Update Issue on Success
        if: steps.plan.outputs.exitcode == '2' && steps.apply.outcome == 'success'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.MY_GITHUB_TOKEN }}
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'drift-detection'
            });

            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '‚úÖ Drift has been automatically remediated. Closing issue.'
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }

      - name: Publish Drift Summary
        if: steps.plan.outputs.exitcode == '2'
        run: |
          echo "### üö® Drift Detected & Auto-Fixed" >> $GITHUB_STEP_SUMMARY
          echo "Terraform has detected and automatically fixed infrastructure drift." >> $GITHUB_STEP_SUMMARY
          echo "Check the [logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details." >> $GITHUB_STEP_SUMMARY

      - name: Close Old Drift Issues
        if: steps.plan.outputs.exitcode == '0'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.MY_GITHUB_TOKEN }}
          script: |
            process.chdir('terraform');
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'drift-detection'
            });

            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '‚úÖ No drift detected. Infrastructure is now in sync.'
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }

      - name: No Drift
        if: steps.plan.outputs.exitcode == '0'
        run: |
          echo "No drift detected. Infrastructure is in sync."
          echo "### ‚úÖ No Drift Detected" >> $GITHUB_STEP_SUMMARY
          echo "Infrastructure is in sync with the configuration." >> $GITHUB_STEP_SUMMARY

      - name: Terraform Plan Failure
        if: steps.plan.outputs.exitcode == '1'
        run: |
          echo "::error::Terraform plan failed."
          exit 1

      # üìä Update Drift Dashboard JSON
      - name: Update Dashboard Data
        run: |
          mkdir -p ../dashboard
          
          # Determine status based on exit code and apply outcome
          EXIT_CODE="${{ steps.plan.outputs.exitcode }}"
          APPLY_OUTCOME="${{ steps.apply.outcome }}"
          
          if [ "$EXIT_CODE" == "0" ]; then
            STATUS="clean"
          elif [ "$EXIT_CODE" == "2" ] && [ "$APPLY_OUTCOME" == "success" ]; then
            STATUS="remediated"
          elif [ "$EXIT_CODE" == "2" ]; then
            STATUS="drift"
          else
            STATUS="error"
          fi
          
          # Get timestamp in IST (UTC+5:30)
          IST_TIMESTAMP=$(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST')
          
          echo "{
            \"environment\": \"${{ inputs.environment }}\",
            \"region\": \"${{ inputs.region }}\",
            \"status\": \"${STATUS}\",
            \"drift_count\": \"${{ steps.plan.outputs.total_drift }}\",
            \"resources_to_add\": \"${{ steps.plan.outputs.add_count }}\",
            \"resources_to_change\": \"${{ steps.plan.outputs.change_count }}\",
            \"resources_to_destroy\": \"${{ steps.plan.outputs.destroy_count }}\",
            \"apply_outcome\": \"${APPLY_OUTCOME:-N/A}\",
            \"timestamp\": \"${IST_TIMESTAMP}\",
            \"workflow_run\": \"${{ github.run_id }}\",
            \"workflow_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
            \"triggered_by\": \"${{ github.actor }}\",
            \"branch\": \"${{ github.ref_name }}\",
            \"commit_sha\": \"${{ github.sha }}\"
          }" > ../dashboard/${{ inputs.environment }}.json

      - name: Commit Dashboard
        env:
          GH_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git
          git fetch origin main
          git reset --soft origin/main
          git add ../dashboard/
          git commit -m "Update drift dashboard - ${{ inputs.environment }}" || echo "No changes to commit"
          git push || echo "No changes to push"         